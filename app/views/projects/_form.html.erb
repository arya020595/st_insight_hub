<%= turbo_frame_tag "modal" do %>
  <div class="modal-header">
    <h5 class="modal-title" id="projectModalLabel">
      <strong><%= @project.new_record? ? 'Create New Project' : 'Edit Project' %></strong>
    </h5>
    <button type="button" class="btn-close btn-close-black" data-bs-dismiss="modal" aria-label="Close"></button>
  </div>
  <%= form_with model: @project, html: { class: 'project-form' }, data: { turbo_frame: "_top" } do |f| %>
    <div class="modal-body">
      <div class="row">
        <div class="col-md-12 mb-3">
          <%= f.label :name, 'Project Name *', class: 'form-label' %>
          <%= f.text_field :name, class: "form-control #{'is-invalid' if @project.errors[:name].any?}", placeholder: 'Enter project name', required: true %>
          <% if @project.errors[:name].any? %>
            <div class="invalid-feedback"><%= @project.errors[:name].first %></div>
          <% end %>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12 mb-3">
          <%= f.label :description, 'Description', class: 'form-label' %>
          <%= f.text_area :description, class: 'form-control', rows: 3, placeholder: 'Optional description...' %>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= f.label :status, 'Status *', class: 'form-label' %>
          <%= f.select :status, options_for_select([['Active', 'active'], ['Inactive', 'inactive']], @project.status || 'active'), {}, class: "form-select #{'is-invalid' if @project.errors[:status].any?}" %>
          <% if @project.errors[:status].any? %>
            <div class="invalid-feedback"><%= @project.errors[:status].first %></div>
          <% end %>
        </div>
        <div class="col-md-6 mb-3"
             data-controller="icon-toggle"
             data-icon-toggle-has-existing-file-value="<%= show_svg_section?(@project) %>"
             data-icon-toggle-default-icon-value="<%= @project.icon.presence || 'bi-folder' %>">
          <%= f.label :icon, 'Sidebar Icon', class: 'form-label' %>
          <%# Hidden field to track which icon type user selected %>
          <%= f.hidden_field :icon_type, value: initial_icon_type(@project), data: { icon_toggle_target: 'iconTypeField' } %>
          <%# Segmented buttons for icon type selection %>
          <div class="btn-group w-100 mb-3" role="group" aria-label="Icon type selection">
            <input type="radio" class="btn-check" name="icon_type_radio" id="iconTypeBootstrap" value="bootstrap"
                   <%= 'checked' unless show_svg_section?(@project) %>
                   data-icon-toggle-target="bootstrapRadio"
                   data-action="change->icon-toggle#toggle">
            <label class="btn btn-outline-primary" for="iconTypeBootstrap">
              <i class="bi bi-bootstrap me-1"></i> Bootstrap Icon
            </label>
            <input type="radio" class="btn-check" name="icon_type_radio" id="iconTypeSvg" value="svg"
                   <%= 'checked' if show_svg_section?(@project) %>
                   data-icon-toggle-target="svgRadio"
                   data-action="change->icon-toggle#toggle">
            <label class="btn btn-outline-primary" for="iconTypeSvg">
              <i class="bi bi-file-earmark-image me-1"></i> Custom SVG
            </label>
          </div>
          <%# Bootstrap Icon Section %>
          <div data-icon-toggle-target="bootstrapSection" style="<%= 'display: none;' if show_svg_section?(@project) %>">
            <%= render 'projects/form/bootstrap_icon_input', f: f, project: @project %>
          </div>
          <%# Custom SVG Section %>
          <div data-icon-toggle-target="svgSection" style="<%= 'display: none;' unless show_svg_section?(@project) %>">
            <%= render 'projects/form/svg_file_input', f: f, project: @project %>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= f.label :sidebar_position, 'Sidebar Position', class: 'form-label' %>
          <%= f.number_field :sidebar_position, class: "form-control", min: 0, value: @project.sidebar_position || 0 %>
          <div class="form-text">Lower number appears first in sidebar</div>
        </div>
        <div class="col-md-6 mb-3 d-flex align-items-center">
          <div class="form-check mt-4">
            <%= f.check_box :show_in_sidebar, class: "form-check-input", checked: @project.show_in_sidebar != false %>
            <%= f.label :show_in_sidebar, 'Show in Sidebar', class: 'form-check-label' %>
          </div>
        </div>
      </div>
      <% if current_user.superadmin? %>
        <div class="row">
          <div class="col-md-12 mb-3">
            <%= f.label :company_id, 'Company', class: 'form-label' %>
            <span class="text-danger">*</span>
            <%= f.select :company_id,
                options_from_collection_for_select(
                  Company.kept.active.order(:name),
                  :id,
                  :name,
                  @project.company_id
                ),
                { include_blank: '-- Select Company --' },
                {
                  class: "form-select #{'is-invalid' if @project.errors[:company].any?}",
                  required: true
                }
            %>
            <% if @project.errors[:company].any? %>
              <div class="invalid-feedback"><%= @project.errors[:company].first %></div>
            <% end %>
            <div class="form-text">Select the company for this project.</div>
          </div>
        </div>
      <% end %>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        <i class="bi bi-arrow-left me-1"></i> Back
      </button>
      <%= f.submit @project.new_record? ? 'Create Project' : 'Update Project', class: 'btn btn-primary' %>
    </div>
  <% end %>
<% end %>
